<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../bower_components/aws-sdk/dist/aws-sdk.min.js">
<link rel="import" href="shared-styles.html">

<dom-module id="my-view3">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      #video_container {
        width: 100vw;
        height: calc(100vh - 65px);
        background: black;
      }
      #camera_stream {
        width: 100vw;
        height: calc(100vh - 65px);
      }

    </style>

    <div id="video_container">
      <video id="camera_stream" width="100vw" autoplay on-tap="_takeSnapshot"></video>
    </div>
  </template>

  <script>
    /* eslint-disable no-trailing-spaces,no-console,max-len */

    class MyView3 extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'my-view3'; }

      constructor() {
        super();

        this.appId = '178738692739662';
        this.roleArn = 'arn:aws:iam::391578767873:role/fof-role';
        this.bucketName = 'fof-hack';
        AWS.config.region = 'ap-southeast-1';

        this.fbUserId;
        this.bucket = new AWS.S3({
          params: {
            Bucket: this.bucketName,
          },
        });

        this.fileChooser; // = this.$.chooser;
        this.button; // = this.$.upload;
        this.results; // = this.$.results;
      }

      ready() {
        super.ready();

        this.fileChooser = this.$.chooser;
        this.button = this.$.upload;
        this.results = this.$.results;
      }

      connectedCallback() {
        super.connectedCallback();

        navigator.getUserMedia = (navigator.getUserMedia ||
          navigator.webkitGetUserMedia ||
          navigator.mozGetUserMedia ||
          navigator.msGetUserMedia);

        window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL;

        if (navigator.getUserMedia) {
          // Request the camera.
          navigator.getUserMedia(
            // Constraints
            {
              video: true,
            },

            // Success Callback
            (localMediaStream) => {
              let video = this.$.camera_stream;
              video.src = (window.URL && window.URL.createObjectURL(localMediaStream)) || localMediaStream;
              video.play();
            },

            // Error Callback
            function(err) {
              // Log the error to the console.
              console.log('The following error occurred when trying to use getUserMedia: ' + err);
            }
          );

        } else {
          alert('Sorry, your browser does not support getUserMedia');
        }
      }

      _takeSnapshot() {
        console.log('video tapped');

        let video = this.$.camera_stream;
        let img = this.querySelector('img') || document.createElement('img');
        console.log(img);
        let context;
        let width = video.offsetWidth;
        let height = video.offsetHeight;

        let canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;

        context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, width, height);

        video.pause();

        img.src = canvas.toDataURL('image/png');
        this.appendChild(img);
      }
    }

    window.customElements.define(MyView3.is, MyView3);
  </script>
</dom-module>
